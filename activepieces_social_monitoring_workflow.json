{
  "name": "Social Media Brand Monitoring - Analytos",
  "description": "Monitors Twitter for brand mentions, analyzes sentiment, and routes to appropriate channels",
  "version": "1.0.0",
  "triggers": [
    {
      "type": "@activepieces/piece-schedule",
      "name": "scheduleEvery15Minutes",
      "displayName": "Schedule Every 15 Minutes",
      "settings": {
        "cronExpression": "*/15 * * * *",
        "timezone": "UTC"
      }
    }
  ],
  "actions": [
    {
      "name": "searchTwitterMentions",
      "displayName": "Search Twitter for Brand Mentions",
      "type": "@activepieces/piece-twitter",
      "settings": {
        "action": "search_tweets",
        "auth": "{{connections.twitter}}",
        "searchQuery": "(@analytos OR analytos.ai OR #analytos) -is:retweet",
        "maxResults": 100,
        "sinceId": "{{store.lastProcessedTweetId}}",
        "expansions": ["author_id", "referenced_tweets.id"],
        "tweetFields": ["created_at", "public_metrics", "conversation_id", "lang"],
        "userFields": ["name", "username", "public_metrics", "verified"]
      }
    },
    {
      "name": "filterRecentTweets",
      "displayName": "Filter Tweets from Last Hour",
      "type": "@activepieces/piece-helper",
      "settings": {
        "action": "filter_array",
        "array": "{{searchTwitterMentions.data}}",
        "condition": {
          "type": "and",
          "conditions": [
            {
              "field": "created_at",
              "operator": "greater_than",
              "value": "{{helper.datetime.subtract(helper.datetime.now(), 1, 'hours')}}"
            }
          ]
        }
      }
    },
    {
      "name": "checkDuplicates",
      "displayName": "Check for Duplicate Processing",
      "type": "@activepieces/piece-store",
      "settings": {
        "action": "get_multiple",
        "keys": "{{helper.array.map(filterRecentTweets.output, 'id')}}",
        "prefix": "processed_tweet_"
      }
    },
    {
      "name": "filterNewTweets",
      "displayName": "Filter Out Already Processed Tweets",
      "type": "@activepieces/piece-helper",
      "settings": {
        "action": "filter_array",
        "array": "{{filterRecentTweets.output}}",
        "condition": {
          "type": "custom",
          "code": "return !checkDuplicates.output[item.id];"
        }
      }
    },
    {
      "name": "loopThroughTweets",
      "displayName": "Process Each Tweet",
      "type": "@activepieces/piece-loop",
      "settings": {
        "items": "{{filterNewTweets.output}}",
        "loopActions": [
          {
            "name": "analyzeSentiment",
            "displayName": "Analyze Tweet Sentiment",
            "type": "@activepieces/piece-openai",
            "settings": {
              "action": "sentiment_analysis",
              "auth": "{{connections.openai}}",
              "text": "{{loopThroughTweets.item.text}}",
              "model": "gpt-3.5-turbo",
              "systemPrompt": "Analyze the sentiment of this tweet about Analytos. Return a JSON object with: {\"sentiment\": \"positive/negative/neutral\", \"score\": 0-100, \"category\": \"support_request/complaint/praise/general\", \"keywords\": []}",
              "temperature": 0.3,
              "maxTokens": 150
            }
          },
          {
            "name": "parseSentimentResult",
            "displayName": "Parse Sentiment Analysis",
            "type": "@activepieces/piece-helper",
            "settings": {
              "action": "parse_json",
              "text": "{{analyzeSentiment.output}}"
            }
          },
          {
            "name": "checkInfluencer",
            "displayName": "Check if User is Influencer",
            "type": "@activepieces/piece-helper",
            "settings": {
              "action": "evaluate_expression",
              "expression": "loopThroughTweets.item.author.public_metrics.followers_count > 10000"
            }
          },
          {
            "name": "checkHighEngagement",
            "displayName": "Check for High Engagement",
            "type": "@activepieces/piece-helper",
            "settings": {
              "action": "evaluate_expression",
              "expression": "(loopThroughTweets.item.public_metrics.like_count + loopThroughTweets.item.public_metrics.retweet_count) > 100"
            }
          },
          {
            "name": "checkNegativeSupport",
            "displayName": "Check if Negative Support Request",
            "type": "@activepieces/piece-helper",
            "settings": {
              "action": "evaluate_expression",
              "expression": "parseSentimentResult.output.sentiment === 'negative' && parseSentimentResult.output.category === 'support_request'"
            }
          },
          {
            "name": "routingBranch",
            "displayName": "Route Based on Analysis",
            "type": "@activepieces/piece-branch",
            "settings": {
              "conditions": [
                {
                  "name": "negativeSupport",
                  "condition": "{{checkNegativeSupport.output === true}}",
                  "actions": [
                    {
                      "name": "createZendeskTicket",
                      "displayName": "Create Zendesk Ticket",
                      "type": "@activepieces/piece-zendesk",
                      "settings": {
                        "action": "create_ticket",
                        "auth": "{{connections.zendesk}}",
                        "subject": "Twitter Support Request - @{{loopThroughTweets.item.author.username}}",
                        "description": "Tweet: {{loopThroughTweets.item.text}}\n\nSentiment Score: {{parseSentimentResult.output.score}}\nCategory: {{parseSentimentResult.output.category}}\n\nUser: @{{loopThroughTweets.item.author.username}}\nFollowers: {{loopThroughTweets.item.author.public_metrics.followers_count}}\n\nTweet Link: https://twitter.com/{{loopThroughTweets.item.author.username}}/status/{{loopThroughTweets.item.id}}",
                        "priority": "high",
                        "tags": ["twitter", "social_support", "negative_sentiment"],
                        "custom_fields": [
                          {
                            "id": "sentiment_score",
                            "value": "{{parseSentimentResult.output.score}}"
                          },
                          {
                            "id": "twitter_handle",
                            "value": "@{{loopThroughTweets.item.author.username}}"
                          }
                        ]
                      }
                    }
                  ]
                },
                {
                  "name": "highEngagement",
                  "condition": "{{checkHighEngagement.output === true}}",
                  "actions": [
                    {
                      "name": "notifyMarketingSlack",
                      "displayName": "Notify Marketing Team on Slack",
                      "type": "@activepieces/piece-slack",
                      "settings": {
                        "action": "send_message",
                        "auth": "{{connections.slack}}",
                        "channel": "#social-alerts",
                        "text": "ðŸ”¥ High Engagement Tweet Alert!",
                        "blocks": [
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*High Engagement Tweet Detected*\n\n*Author:* @{{loopThroughTweets.item.author.username}}\n*Engagement:* {{loopThroughTweets.item.public_metrics.like_count}} likes, {{loopThroughTweets.item.public_metrics.retweet_count}} retweets\n*Sentiment:* {{parseSentimentResult.output.sentiment}} ({{parseSentimentResult.output.score}}/100)"
                            }
                          },
                          {
                            "type": "section",
                            "text": {
                              "type": "mrkdwn",
                              "text": "*Tweet:*\n{{loopThroughTweets.item.text}}"
                            }
                          },
                          {
                            "type": "actions",
                            "elements": [
                              {
                                "type": "button",
                                "text": {
                                  "type": "plain_text",
                                  "text": "View on Twitter"
                                },
                                "url": "https://twitter.com/{{loopThroughTweets.item.author.username}}/status/{{loopThroughTweets.item.id}}"
                              }
                            ]
                          }
                        ]
                      }
                    }
                  ]
                },
                {
                  "name": "influencerMention",
                  "condition": "{{checkInfluencer.output === true}}",
                  "actions": [
                    {
                      "name": "addToInfluencerCRM",
                      "displayName": "Add to Influencer CRM",
                      "type": "@activepieces/piece-airtable",
                      "settings": {
                        "action": "create_record",
                        "auth": "{{connections.airtable}}",
                        "baseId": "{{config.influencerCRMBaseId}}",
                        "tableId": "{{config.influencerCRMTableId}}",
                        "fields": {
                          "Name": "@{{loopThroughTweets.item.author.username}}",
                          "Platform": "Twitter",
                          "Followers": "{{loopThroughTweets.item.author.public_metrics.followers_count}}",
                          "Verified": "{{loopThroughTweets.item.author.verified}}",
                          "FirstMention": "{{helper.datetime.format(loopThroughTweets.item.created_at, 'YYYY-MM-DD HH:mm:ss')}}",
                          "TweetLink": "https://twitter.com/{{loopThroughTweets.item.author.username}}/status/{{loopThroughTweets.item.id}}",
                          "Sentiment": "{{parseSentimentResult.output.sentiment}}",
                          "EngagementScore": "{{loopThroughTweets.item.public_metrics.like_count + loopThroughTweets.item.public_metrics.retweet_count}}"
                        }
                      }
                    }
                  ]
                }
              ]
            }
          },
          {
            "name": "logToGoogleSheets",
            "displayName": "Log Mention to Dashboard",
            "type": "@activepieces/piece-google-sheets",
            "settings": {
              "action": "append_values",
              "auth": "{{connections.googleSheets}}",
              "spreadsheetId": "{{config.dashboardSpreadsheetId}}",
              "range": "Mentions!A:J",
              "values": [
                [
                  "{{helper.datetime.format(helper.datetime.now(), 'YYYY-MM-DD HH:mm:ss')}}",
                  "{{loopThroughTweets.item.id}}",
                  "@{{loopThroughTweets.item.author.username}}",
                  "{{loopThroughTweets.item.author.public_metrics.followers_count}}",
                  "{{loopThroughTweets.item.text}}",
                  "{{parseSentimentResult.output.sentiment}}",
                  "{{parseSentimentResult.output.score}}",
                  "{{parseSentimentResult.output.category}}",
                  "{{loopThroughTweets.item.public_metrics.like_count}}",
                  "{{loopThroughTweets.item.public_metrics.retweet_count}}"
                ]
              ]
            }
          },
          {
            "name": "markAsProcessed",
            "displayName": "Mark Tweet as Processed",
            "type": "@activepieces/piece-store",
            "settings": {
              "action": "put",
              "key": "processed_tweet_{{loopThroughTweets.item.id}}",
              "value": {
                "id": "{{loopThroughTweets.item.id}}",
                "processedAt": "{{helper.datetime.now()}}",
                "sentiment": "{{parseSentimentResult.output.sentiment}}",
                "category": "{{parseSentimentResult.output.category}}"
              },
              "expiresIn": 86400
            }
          }
        ]
      }
    },
    {
      "name": "updateLastProcessedId",
      "displayName": "Update Last Processed Tweet ID",
      "type": "@activepieces/piece-store",
      "settings": {
        "action": "put",
        "key": "lastProcessedTweetId",
        "value": "{{helper.array.max(filterNewTweets.output, 'id')}}"
      }
    },
    {
      "name": "checkDailyDigestTime",
      "displayName": "Check if Time for Daily Digest",
      "type": "@activepieces/piece-helper",
      "settings": {
        "action": "evaluate_expression",
        "expression": "helper.datetime.format(helper.datetime.now(), 'HH:mm') === '09:00'"
      }
    },
    {
      "name": "dailyDigestBranch",
      "displayName": "Send Daily Digest if Scheduled",
      "type": "@activepieces/piece-branch",
      "settings": {
        "conditions": [
          {
            "name": "sendDigest",
            "condition": "{{checkDailyDigestTime.output === true}}",
            "actions": [
              {
                "name": "getDailyStats",
                "displayName": "Get Daily Statistics",
                "type": "@activepieces/piece-google-sheets",
                "settings": {
                  "action": "get_values",
                  "auth": "{{connections.googleSheets}}",
                  "spreadsheetId": "{{config.dashboardSpreadsheetId}}",
                  "range": "DailyStats!A1:E10"
                }
              },
              {
                "name": "sendDailyDigest",
                "displayName": "Send Daily Digest Email",
                "type": "@activepieces/piece-sendgrid",
                "settings": {
                  "action": "send_email",
                  "auth": "{{connections.sendgrid}}",
                  "to": ["marketing@analytos.ai"],
                  "subject": "Daily Social Media Report - {{helper.datetime.format(helper.datetime.now(), 'YYYY-MM-DD')}}",
                  "html": "<h2>Daily Social Media Report</h2><p>Date: {{helper.datetime.format(helper.datetime.now(), 'YYYY-MM-DD')}}</p><h3>Summary</h3><ul><li>Total Mentions: {{getDailyStats.output[1][1]}}</li><li>Positive: {{getDailyStats.output[2][1]}}</li><li>Negative: {{getDailyStats.output[3][1]}}</li><li>Neutral: {{getDailyStats.output[4][1]}}</li></ul><h3>Key Metrics</h3><ul><li>Support Requests: {{getDailyStats.output[5][1]}}</li><li>High Engagement Posts: {{getDailyStats.output[6][1]}}</li><li>Influencer Mentions: {{getDailyStats.output[7][1]}}</li></ul><p>View full dashboard: {{config.dashboardUrl}}</p>"
                }
              }
            ]
          }
        ]
      }
    }
  ],
  "errorHandling": {
    "onError": "continue",
    "retryPolicy": {
      "maxAttempts": 3,
      "backoffMultiplier": 2,
      "initialInterval": 1000
    },
    "errorActions": [
      {
        "name": "logError",
        "displayName": "Log Error to Monitoring",
        "type": "@activepieces/piece-webhook",
        "settings": {
          "url": "{{config.errorWebhookUrl}}",
          "method": "POST",
          "headers": {
            "Content-Type": "application/json",
            "X-API-Key": "{{config.monitoringApiKey}}"
          },
          "body": {
            "workflow": "social-media-monitoring",
            "error": "{{error.message}}",
            "step": "{{error.stepName}}",
            "timestamp": "{{helper.datetime.now()}}",
            "context": "{{error.context}}"
          }
        }
      }
    ]
  },
  "rateLimiting": {
    "twitter": {
      "requestsPerWindow": 180,
      "windowDuration": 900000,
      "strategy": "sliding-window"
    },
    "zendesk": {
      "requestsPerWindow": 200,
      "windowDuration": 60000
    },
    "slack": {
      "requestsPerWindow": 50,
      "windowDuration": 60000
    }
  },
  "config": {
    "dashboardSpreadsheetId": "1234567890abcdefg",
    "influencerCRMBaseId": "appXXXXXXXXXXXXXX",
    "influencerCRMTableId": "tblYYYYYYYYYYYYYY",
    "dashboardUrl": "https://docs.google.com/spreadsheets/d/1234567890abcdefg",
    "errorWebhookUrl": "https://monitoring.analytos.ai/webhook/errors",
    "monitoringApiKey": "{{secrets.monitoringApiKey}}"
  },
  "connections": {
    "twitter": {
      "type": "oauth2",
      "required": true
    },
    "openai": {
      "type": "api-key",
      "required": true
    },
    "zendesk": {
      "type": "oauth2",
      "required": true
    },
    "slack": {
      "type": "oauth2",
      "required": true
    },
    "googleSheets": {
      "type": "oauth2",
      "required": true
    },
    "airtable": {
      "type": "api-key",
      "required": true
    },
    "sendgrid": {
      "type": "api-key",
      "required": true
    }
  }
}